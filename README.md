# Multi-frequency_Point_Synthetic_Analog_Signal_Data_Transmission_System

Project for Embedded Advanced Experiment.



<div>
<div style="width:52px;float:left; font-family:方正公文黑体;">摘　要：</div> 
<div style="overflow:hidden; font-family:华文楷体;">多频点合成模拟信号数据传输，我们选择4kHz，8kHz，12kHz，16kHz频点进行传输，并与需传输的数据进行逐位相乘，叠加合成信号，再由stm32进行AD采样，获得合成信号的特征点，经过FFT解调，得到出现峰峰值的频率点，由此可得传输的信号。整个实验可分为波形发生模块、波形叠加模块、波形AD采样、FFT快速傅里叶模块、通信传输模块。分别实现各个模块并确认运行正常后，我们对系统进行整体测试。</div>
</div>



## 实验要求

+ 实现一个用 4~20kHz 频带内的多频点（≥4，频点频率及频点个数均可选，但频率需为 kHz 的整数倍）合成模拟信号进行数字比特流传输的系统；

+ 要求能实现 32 比特或 32 比特整数倍（最多不超过 32*5=160 比特）的二进制数据传输；

+ 指标有总传输比特数、传输时间、 误码率、信道衰减倍数、信噪比等。 MCU、FPGA 开发板自备；

+ 使用器件为常规器件（接插件、电阻、电容、电位器）以及如下运放芯片：LM324、OP07、OP27、OP37。不允许使用其他器件

+ 基本要求

  在不进行信道衰减和噪声叠加的情况下完成系统功能。

+ 发挥部分

  在一定的信道衰减和噪声叠加后完成系统功能。注意以降低误码率为最终目的的前提下 有取舍地提高衰减倍数和叠加噪声强度。

  


## 实验设备

+ STM32F103RCT6核心板
+ 电阻
+ LM324芯片
+ HEF4066B芯片
+ 面包板
+ PC机
+ keil软件

## 实验原理　　

​	多频点信号指多个单频正弦信号的合成（合成后的信号电压峰峰值在3~5V），其中每个正弦信号会乘上一个系数（0或1）。我们选择4kHz，8kHz，12kHz，16kHz频点进行传输，要传输的数据为1010(B)，则应把一个4kHz正弦波和12kHz正弦波合成，8kHz和12kHz信号乘上的系数是0，不参与合成。再由stm32进行AD采样获得合成波形的特征点，经过FFT解调，得到在两个频率点下出现峰峰值——4kHz和12kHz，由此可得传输的信号为1010(B).

### 波形发生模块

#### 硬件实现

​	采用RC振荡器 - 文氏电桥振荡器，电路原理图如下所示：

<img src="image-20210728151357792.png" alt="image-20210727113358210" style="zoom:33%;" />

<center><strong>图 1  RC振荡器原理图 </strong></center>

#### 软件实现

​	我们在老师的建议下，并参考相关例程，采用开发板上的DMA模块和DAC模块作为正弦波波形的发生器。具体步骤为：

+ 用matlab计算获取正弦波数据表；
+ 根据正弦波数据表的周期内点数和周期计算定时器触发间隔；
+ 初始化 DAC 输出通道，初始化 DAC 工作模式；
+ 配置触发 DAC 用的定时器，根据频率选择定时器中断触发的时间；
+ 配置 DMA 自动转运正弦波数据表.

​	但由于板子和外设DA模块都无法在短时间获得，我们果断放弃此方案，采用硬件实现。

### 波形叠加模块

#### 加法电路

​	电路原理图：

​	                                       <img src="image-20210728151357792.png" alt="image-20210728151357792" style="zoom:50%;" />

<center><strong>图 2  加法电路原理图 </strong></center>

​	三个输入信号同时加到运放同相端，当$R_1=R_2=R_3$时，其输入输出电压关系式为：
$$
V_o=\frac{1}4(V_1+V_2+V_3+V_4)(1+\frac{R_5}{R_4})
$$
我们再令$R_5=3R_4$​，则有
$$
V_o=V_1+V_2+V_3+V_4
$$

#### 选择模块

​	用CD4066四双向模拟开关进行选择控制，主要用作模拟或数字信号的多路传输。每个模拟开关有输入、输出、控制三个端子，其中输入端和输出端可互换.

​                               <img src="校赛实验报告\image-20210728154820765.png" alt="image-20210728154820765" style="zoom:67%;" />       <img src="校赛实验报告\image-20210728154855933.png" alt="image-20210728154855933" style="zoom:67%;" />

<center><strong>图 3  4066芯片管脚图 </strong></center>

### 波形采样——ADC模块

​	对波形进行采样，4$\mu s$采一个点，共采128个点。

​	ADC配置步骤：

+ 使能端口时钟和 ADC 时钟，设置引脚模式为模拟输入；
+ 设置 ADC 的分频因子；
+ 初始化 ADC 参数，包括 ADC 工作模式、规则序列等；
+ 使能 ADC 并校准；
+ 读取 ADC 转换.

### 快速傅里叶变换(ftt)	

#### FFT原理

​	FFT是一种DFT的高校算法，称为快速傅里叶变换。FFT算法可分为按时间抽取算法和按频率抽取算法。

​	DFT运算：
$$
X(k)=DFT[x(n)]=\sum^{N-1}_{n=0}x(n)W_N^{kn}, k=0,1,...,N-1
$$

$$
x(n)=IDFT[X(k)]=\sum_{k=0}^{N-1}X(k)W_N^{-kn}, n=0,1,...,N-1
$$

式中$W_N=e^{-j\frac{2\pi}{N}}$

由这种方法计算DFT对于X（K）的每个K值，需要进行4N次实数相乘和（4N-2）次相加，对于N个k值，共需N*N乘和N（4N-2）次实数相加。改进DFT算法，减小它的运算量，利用DFT中$W_N^{kn}$​的周期性和对称性，使整个DFT的计算变成一系列迭代运算，可大幅度提高运算过程和运算量，这是FFT的基本思想。

#### 	c语言实现FFT

+ 将输入信号的实部和虚部分别赋值给数组
+ 将$w=e^{-j2\frac{\pi}{n}}$用欧拉公式表示
+ 蝴蝶操作

### 通信模块

​	DMA，全称是 Direct Memory Access. DMA 可用于实现外设与存储器之间或者存储器与存储器之间数据传输的高效性。之所以称为高效，是因为 DMA 传输数据移动过程无需 CPU 直接操作，这样节省的 CPU 资源就可供其它操作使用。从硬件层面来理解，DMA 就好像是 RAM 与 I/O 设备间数据传输的通路，外设与存储器之间或者存储器与存储器之间可以直接在这条通路上进行数据传输。这里说的外设一般指外设的数据存器，比如ADC、SPI、I2C、 DCMI等外设的数据寄存器，存储器一般是指片内 SRAM、外部存储器、片内 Flash等。

​	配置步骤：

+ 使能DMA控制器（DMA1或DMA2）时钟
+ 初始化DMA通道，包括配置通道、外设和内存地址、传输数据量等。
+ 使能外设DMA功能（DMA请求映射图对应的外设）
+ 开启DMA的通信传输
+ 查询DMA传输状态